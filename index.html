<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kcal Conteur</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        neon: '#00ff88',
                        darkbg: '#050505',
                        darkcard: '#111111',
                    }
                }
            }
        }
    </script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #050505;
            color: #ffffff;
            -webkit-tap-highlight-color: transparent;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        .fade-in { animation: fadeIn 0.4s ease-out; }
        .slide-up { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1); }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .progress-ring__circle {
            transition: stroke-dashoffset 1s cubic-bezier(0.4, 0, 0.2, 1);
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            filter: drop-shadow(0 0 8px rgba(0, 255, 136, 0.6));
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .nav-btn { color: #52525b; transition: all 0.3s ease; }
        .nav-btn.active { color: #00ff88; text-shadow: 0 0 10px rgba(0,255,136,0.5); }
        .nav-btn.active .nav-icon-bg { 
            background-color: rgba(0, 255, 136, 0.1); 
            box-shadow: inset 0 0 10px rgba(0,255,136,0.2);
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .btn-neon {
            background: #00ff88;
            color: #000;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
            transition: all 0.2s ease;
        }
        .btn-neon:hover {
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.6);
            transform: translateY(-2px);
        }
        .btn-neon:active {
            transform: translateY(1px);
        }

        .glass-card {
            background: rgba(17, 17, 17, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .text-glow {
            text-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
        }
    </style>
</head>
<body class="sm:flex sm:justify-center sm:items-start sm:p-6 min-h-screen selection:bg-neon selection:text-black">

    <div class="w-full sm:max-w-md glass-card sm:rounded-[2.5rem] sm:shadow-[0_0_50px_rgba(0,0,0,0.8)] overflow-hidden flex flex-col h-[100dvh] sm:h-[850px] relative border-x border-b border-zinc-900/50">
        
        <!-- En-t√™te Global -->
        <header class="pt-12 pb-6 px-6 relative z-20 border-b border-white/5 bg-gradient-to-b from-black to-transparent">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h1 class="text-4xl font-black tracking-tighter bg-gradient-to-r from-neon to-emerald-300 bg-clip-text text-transparent text-glow uppercase italic">
                        Kcal Conteur
                    </h1>
                    <p class="text-zinc-400 text-sm font-medium tracking-wide mt-1">
                        Objectif <span class="text-neon font-bold">65 kg</span> (+10 kg)
                    </p>
                </div>
            </div>
            
            <div class="mt-6 bg-zinc-900 rounded-full h-1.5 w-full overflow-hidden border border-zinc-800">
                <div id="header-progress-bar" class="bg-neon h-full rounded-full transition-all duration-1000 shadow-[0_0_10px_#00ff88]" style="width: 0%"></div>
            </div>
            <div class="flex justify-between mt-2 text-[11px] font-bold text-zinc-500 uppercase tracking-wider">
                <span id="header-calories-text" class="text-neon">0 kcal valid√©es</span>
                <span>But: 2850</span>
            </div>
        </header>

        <!-- Contenu Principal (ajout de pb-32 pour d√©gager la barre du bas) -->
        <main class="flex-1 overflow-y-auto p-5 pb-32 no-scrollbar relative z-10">

            <!-- VUE 1 : SCANNER -->
            <section id="view-scan" class="fade-in block">
                <div class="flex justify-between items-center mb-5">
                    <h2 class="text-sm font-bold text-zinc-400 uppercase tracking-widest flex items-center gap-2">
                        <i class="fa-solid fa-crosshairs text-neon"></i> Mode <span class="text-white">Analyse</span>
                    </h2>
                    <!-- BOUTON : R√©initialiser (agrandi et bien accessible) -->
                    <button id="btn-new-scan" onclick="resetScanner()" class="hidden text-xs font-bold text-zinc-300 hover:text-neon uppercase tracking-widest border border-zinc-700 hover:border-neon/50 px-4 py-2 rounded-lg transition-colors bg-zinc-900 shadow-md z-30">
                        <i class="fa-solid fa-trash-can mr-2"></i> Nouveau
                    </button>
                </div>

                <!-- Zone d'upload -->
                <div id="upload-zone" onclick="document.getElementById('file-input').click()" class="relative border border-dashed border-zinc-700 rounded-3xl p-10 flex flex-col items-center justify-center text-center cursor-pointer hover:bg-zinc-900/50 hover:border-neon/50 transition-all bg-darkcard group overflow-hidden z-20">
                    <div class="absolute inset-0 bg-neon/5 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
                    <div class="bg-zinc-900 border border-zinc-800 text-neon w-20 h-20 rounded-full mb-5 flex items-center justify-center shadow-[0_0_15px_rgba(0,255,136,0.15)] group-hover:scale-110 transition-transform">
                        <i class="fa-solid fa-camera text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-black mb-2 text-white uppercase tracking-wide">Scanner <span class="text-neon">l'assiette</span></h3>
                    <p class="text-zinc-500 text-xs">L'IA va d√©tecter les <span class="text-white font-bold">calories</span> et les <span class="text-white font-bold">macros</span></p>
                </div>

                <!-- Image Preview -->
                <div id="image-preview-container" class="relative rounded-3xl overflow-hidden shadow-2xl mb-6 bg-black border border-zinc-800 hidden">
                    <img id="image-preview" src="" alt="Repas" class="w-full h-72 object-cover opacity-80" />
                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 to-transparent pointer-events-none"></div>
                    
                    <!-- Bouton Croix (agrandi et z-index augment√©) -->
                    <button id="btn-reset-photo" onclick="resetScanner()" class="absolute top-4 right-4 z-30 bg-black/60 backdrop-blur-md border border-white/20 text-white w-12 h-12 rounded-full hover:bg-red-500 hover:text-white hover:border-red-500 transition-all flex items-center justify-center shadow-lg">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>

                <input type="file" id="file-input" accept="image/*" class="hidden" onchange="handleImageUpload(event)" />

                <!-- Message d'erreur -->
                <div id="error-message" class="hidden mt-4 p-4 bg-red-950/30 border border-red-500/30 text-red-400 rounded-2xl flex items-start gap-3 text-sm z-20 relative">
                    <i class="fa-solid fa-bug mt-0.5 text-lg"></i>
                    <p id="error-text" class="font-medium"></p>
                </div>

                <!-- Bouton Analyser (Z-index garanti) -->
                <button id="btn-analyze" onclick="analyzeImage()" class="hidden w-full mt-4 btn-neon font-black py-4 rounded-2xl flex items-center justify-center gap-3 text-lg uppercase tracking-wider z-20 relative shadow-[0_0_20px_rgba(0,255,136,0.3)]">
                    <i class="fa-solid fa-microchip text-xl"></i> Extraire les <span class="text-black font-black">donn√©es</span>
                </button>

                <!-- Zone de chargement -->
                <div id="loading-zone" class="hidden mt-8 flex flex-col items-center justify-center text-center bg-darkcard p-8 rounded-3xl border border-zinc-800 relative overflow-hidden z-20">
                    <div class="absolute top-0 left-0 w-full h-1 bg-zinc-800 pointer-events-none">
                        <div class="h-full bg-neon animate-[pulse_1s_ease-in-out_infinite] w-1/2"></div>
                    </div>
                    <i class="fa-solid fa-radar fa-spin text-neon text-4xl mb-5"></i>
                    <h3 class="text-lg font-bold text-white uppercase tracking-wider">Analyse <span class="text-neon">neuronale</span></h3>
                    <p class="text-zinc-500 text-xs mt-2">Identification des <span class="text-white">macronutriments</span> en cours...</p>
                </div>

                <!-- R√©sultats -->
                <div id="results-zone" class="hidden mt-6 slide-up z-20 relative">
                    <div class="bg-zinc-900 border border-neon/30 rounded-3xl p-6 mb-6 relative overflow-hidden shadow-[0_0_30px_rgba(0,255,136,0.05)]">
                        <div class="absolute -right-10 -top-10 text-neon opacity-5 pointer-events-none">
                            <i class="fa-solid fa-fire text-9xl"></i>
                        </div>
                        <p class="text-zinc-400 text-xs font-bold uppercase tracking-widest mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-bolt text-neon"></i> Total <span class="text-neon">Estim√©</span>
                        </p>
                        <div class="flex items-end gap-2 mb-6">
                            <span id="result-total-calories" class="text-7xl font-black text-white tracking-tighter text-glow leading-none">0</span>
                            <span class="text-xl font-bold text-neon mb-1">KCAL</span>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 text-center">
                            <div class="bg-black/50 border border-zinc-800 rounded-2xl p-3">
                                <span id="result-protein" class="block font-black text-xl text-white">0g</span>
                                <span class="text-[10px] font-bold text-zinc-500 uppercase tracking-wider">Prot√©ines</span>
                            </div>
                            <div class="bg-black/50 border border-zinc-800 rounded-2xl p-3">
                                <span id="result-carbs" class="block font-black text-xl text-white">0g</span>
                                <span class="text-[10px] font-bold text-zinc-500 uppercase tracking-wider">Glucides</span>
                            </div>
                            <div class="bg-black/50 border border-zinc-800 rounded-2xl p-3">
                                <span id="result-fat" class="block font-black text-xl text-white">0g</span>
                                <span class="text-[10px] font-bold text-zinc-500 uppercase tracking-wider">Lipides</span>
                            </div>
                        </div>
                    </div>

                    <h3 class="font-bold text-zinc-400 text-xs uppercase tracking-widest mb-4 ml-1">Composants <span class="text-white">D√©tect√©s</span></h3>
                    <div id="results-items" class="space-y-3 mb-6"></div>

                    <!-- Bouton Ajouter au compteur (parfaitement accessible maintenant) -->
                    <button onclick="switchTab('goal'); resetScanner();" class="w-full bg-zinc-800 hover:bg-zinc-700 active:bg-zinc-600 text-white font-bold py-5 rounded-2xl transition-all mb-4 uppercase tracking-wider text-sm border border-zinc-600 shadow-lg relative z-30 cursor-pointer">
                        Ajouter au <span class="text-neon">compteur</span>
                    </button>
                </div>
            </section>

            <!-- VUE 2 : OBJECTIF -->
            <section id="view-goal" class="fade-in hidden">
                <h2 class="text-sm font-bold text-zinc-400 mb-5 uppercase tracking-widest flex items-center gap-2">
                    <i class="fa-solid fa-chart-line text-neon"></i> Suivi <span class="text-white">Quotidien</span>
                </h2>

                <div class="bg-darkcard border border-zinc-800 rounded-3xl p-8 mb-6 text-center relative overflow-hidden">
                    <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-neon/10 via-transparent to-transparent opacity-50 pointer-events-none"></div>
                    
                    <div class="relative w-56 h-56 mx-auto mb-6">
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="42" stroke="#18181b" stroke-width="8" fill="none" />
                            <circle id="progress-circle" class="progress-ring__circle" cx="50" cy="50" r="42" stroke="#00ff88" stroke-width="8" fill="none" stroke-linecap="round" stroke-dasharray="263.89" stroke-dashoffset="263.89" />
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                            <span class="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-1">Actuel</span>
                            <span id="goal-calories-eaten" class="text-5xl font-black text-white text-glow">0</span>
                            <div class="w-8 h-1 bg-zinc-800 my-2 rounded-full"></div>
                            <span class="text-sm font-bold text-zinc-400">2850 <span class="text-neon">KCAL</span></span>
                        </div>
                    </div>
                    <div id="goal-message-container">
                        <p class="text-zinc-400 text-sm font-medium">
                            Il te manque <span id="goal-calories-remaining" class="text-neon font-black text-lg">2850 kcal</span> pour <span class="text-white">exploser</span> ton but.
                        </p>
                    </div>
                </div>

                <h2 class="text-sm font-bold text-zinc-400 mb-4 uppercase tracking-widest flex items-center gap-2">
                    <i class="fa-solid fa-skull text-neon"></i> D√©fi <span class="text-white">Prise de masse</span>
                </h2>
                <div class="bg-zinc-900 border border-zinc-800 rounded-3xl p-6 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-neon/10 rounded-full blur-3xl -mr-10 -mt-10 group-hover:bg-neon/20 transition-colors pointer-events-none"></div>
                    <div class="bg-black text-neon w-max px-3 py-1.5 rounded-lg text-[10px] font-black tracking-widest uppercase border border-neon/30 mb-4 relative z-10">
                        Mission du jour
                    </div>
                    <h3 id="challenge-title" class="text-xl font-black text-white mb-2 uppercase relative z-10">Chargement...</h3>
                    <p id="challenge-desc" class="text-zinc-400 text-sm leading-relaxed relative z-10"></p>
                </div>
            </section>

            <!-- VUE 3 : HISTORIQUE -->
            <section id="view-history" class="fade-in hidden">
                <h2 class="text-sm font-bold text-zinc-400 mb-5 uppercase tracking-widest flex items-center gap-2">
                    <i class="fa-solid fa-database text-neon"></i> Logs <span class="text-white">Alimentaires</span>
                </h2>

                <div id="history-empty" class="text-center py-20 px-4 border border-dashed border-zinc-800 rounded-3xl bg-darkcard">
                    <div class="w-16 h-16 rounded-2xl bg-zinc-900 border border-zinc-800 flex items-center justify-center mx-auto mb-4 text-zinc-600">
                        <i class="fa-solid fa-ban text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-bold text-white uppercase tracking-wider">Base de donn√©es <span class="text-neon">vide</span></h3>
                    <p class="text-zinc-500 text-sm mt-2">En attente de nouvelles <span class="text-white font-bold">entr√©es caloriques</span>.</p>
                </div>

                <div id="history-list" class="space-y-4 hidden"></div>
            </section>

        </main>

        <!-- Navigation du bas (Z-index 50 garanti pour survoler le reste) -->
        <nav class="absolute bottom-0 left-0 right-0 bg-black/90 backdrop-blur-xl border-t border-zinc-800 px-6 py-3 flex justify-between items-center z-50 sm:rounded-b-[2.5rem]">
            <button onclick="switchTab('scan')" id="nav-scan" class="nav-btn active flex flex-col items-center p-2 w-20 cursor-pointer">
                <div class="nav-icon-bg p-2 rounded-xl border border-transparent">
                    <i class="fa-solid fa-camera-viewfinder text-xl"></i>
                </div>
                <span class="text-[9px] font-black uppercase tracking-widest mt-1">Scan</span>
            </button>
            
            <button onclick="switchTab('goal')" id="nav-goal" class="nav-btn flex flex-col items-center p-2 w-20 cursor-pointer">
                <div class="nav-icon-bg p-2 rounded-xl border border-transparent">
                    <i class="fa-solid fa-chart-pie text-xl"></i>
                </div>
                <span class="text-[9px] font-black uppercase tracking-widest mt-1">Stats</span>
            </button>

            <button onclick="switchTab('history')" id="nav-history" class="nav-btn flex flex-col items-center p-2 w-20 cursor-pointer">
                <div class="nav-icon-bg p-2 rounded-xl border border-transparent">
                    <i class="fa-solid fa-layer-group text-xl"></i>
                </div>
                <span class="text-[9px] font-black uppercase tracking-widest mt-1">Logs</span>
            </button>
        </nav>
    </div>

    <!-- LOGIQUE JAVASCRIPT -->
    <script>
        const DAILY_GOAL = 2850;
        const API_KEY = "AIzaSyBzL8DKf_Ji_6KgyzwbOHg_NpVCyi6YbYY";
        let currentImageBase64 = null;
        let currentMimeType = null;
        let historyData = [];

        const DAILY_CHALLENGES = [
            { title: "Boost Ol√©agineux", desc: "Mange une grosse poign√©e d'amandes ou noix aujourd'hui en collation pour faire exploser tes <span class='text-neon font-bold'>calories</span> (+250 kcal)." },
            { title: "Or Liquide", desc: "Ajoute une cuill√®re √† soupe d'huile d'olive sur ton plat principal pour gonfler les <span class='text-neon font-bold'>lipides</span> (+120 kcal)." },
            { title: "Gainer Maison", desc: "Mixe un smoothie : 1 banane, lait entier, et beurre de cacahu√®te. Un concentr√© pur de <span class='text-neon font-bold'>masse</span>." }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            initChallengeOfDay();
            updateProgressUI();
        });

        function switchTab(tabId) {
            document.querySelectorAll('main > section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('nav > button').forEach(el => el.classList.remove('active'));

            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            document.getElementById(`nav-${tabId}`).classList.add('active');
            
            if (tabId === 'history') renderHistory();
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const result = reader.result;
                    currentImageBase64 = result.split(',')[1];
                    currentMimeType = result.split(';')[0].split(':')[1];
                    
                    document.getElementById('image-preview').src = result;
                    document.getElementById('upload-zone').classList.add('hidden');
                    document.getElementById('image-preview-container').classList.remove('hidden');
                    document.getElementById('btn-analyze').classList.remove('hidden');
                    document.getElementById('results-zone').classList.add('hidden');
                    document.getElementById('error-message').classList.add('hidden');
                    
                    document.getElementById('btn-new-scan').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function resetScanner() {
            document.getElementById('file-input').value = '';
            currentImageBase64 = null;
            document.getElementById('upload-zone').classList.remove('hidden');
            document.getElementById('image-preview-container').classList.add('hidden');
            document.getElementById('btn-analyze').classList.add('hidden');
            document.getElementById('results-zone').classList.add('hidden');
            document.getElementById('btn-new-scan').classList.add('hidden');
            
            // Forcer le scroll tout en haut
            document.querySelector('main').scrollTo(0, 0);
        }

        async function analyzeImage() {
            if (!currentImageBase64) return;
            
            document.getElementById('btn-analyze').classList.add('hidden');
            document.getElementById('btn-reset-photo').classList.add('hidden');
            document.getElementById('loading-zone').classList.remove('hidden');
            document.getElementById('error-message').classList.add('hidden');

            const prompt = `Analyse cette image de nourriture. 
            1. Identifie tous les aliments pr√©sents.
            2. Estime les calories pour chaque aliment.
            3. Estime les macronutriments (prot√©ines, glucides, lipides) en grammes.
            4. Calcule le total des calories.
            Sois g√©n√©reux sur les estimations, l'utilisateur cherche √† prendre du poids.`;

            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: prompt },
                        { inlineData: { mimeType: currentMimeType, data: currentImageBase64 } }
                    ]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            items: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        name: { type: "STRING" },
                                        calories: { type: "NUMBER" },
                                        protein: { type: "NUMBER" },
                                        carbs: { type: "NUMBER" },
                                        fat: { type: "NUMBER" },
                                        portion: { type: "STRING" }
                                    },
                                    required: ["name", "calories", "protein", "carbs", "fat", "portion"]
                                }
                            },
                            totalCalories: { type: "NUMBER" }
                        },
                        required: ["items", "totalCalories"]
                    }
                }
            };

            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    }
                );

                if (!response.ok) {
                    if (response.status === 400) throw new Error("Cl√© API invalide ou acc√®s refus√©.");
                    throw new Error("√âchec de la connexion aux serveurs de l'IA.");
                }

                const data = await response.json();
                const jsonText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                const parsedResult = JSON.parse(jsonText);

                saveToHistory(parsedResult);
                displayResults(parsedResult);

            } catch (err) {
                document.getElementById('error-text').innerText = err.message;
                document.getElementById('error-message').classList.remove('hidden');
                document.getElementById('btn-analyze').classList.remove('hidden');
                document.getElementById('btn-reset-photo').classList.remove('hidden');
            }

            document.getElementById('loading-zone').classList.add('hidden');
        }

        function displayResults(results) {
            document.getElementById('results-zone').classList.remove('hidden');
            document.getElementById('btn-new-scan').classList.remove('hidden');
            
            document.getElementById('result-total-calories').innerText = Math.round(results.totalCalories);
            
            let totalP = 0, totalC = 0, totalF = 0, itemsHtml = '';

            results.items.forEach(item => {
                totalP += item.protein; totalC += item.carbs; totalF += item.fat;
                itemsHtml += `
                    <div class="bg-black/50 border border-zinc-800 rounded-2xl p-4 flex flex-col hover:border-neon/30 transition-colors">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-white capitalize">${item.name}</h4>
                                <p class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest mt-1">${item.portion}</p>
                            </div>
                            <span class="font-black text-neon bg-neon/10 border border-neon/20 px-3 py-1.5 rounded-lg text-sm">
                                ${Math.round(item.calories)} <span class="text-[10px]">KCAL</span>
                            </span>
                        </div>
                    </div>`;
            });

            document.getElementById('result-protein').innerText = `${Math.round(totalP)}g`;
            document.getElementById('result-carbs').innerText = `${Math.round(totalC)}g`;
            document.getElementById('result-fat').innerText = `${Math.round(totalF)}g`;
            document.getElementById('results-items').innerHTML = itemsHtml;
            updateProgressUI();
            
            // D√©filer automatiquement vers le bouton du bas
            setTimeout(() => {
                document.querySelector('main').scrollTo({
                    top: document.querySelector('main').scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }

        function saveToHistory(results) {
            historyData.unshift({
                id: Date.now(),
                date: new Date(),
                image: document.getElementById('image-preview').src,
                results: results
            });
        }

        function updateProgressUI() {
            const eaten = Math.round(historyData
                .filter(m => m.date.toDateString() === new Date().toDateString())
                .reduce((sum, m) => sum + m.results.totalCalories, 0));
                
            const percentage = Math.min((eaten / DAILY_GOAL) * 100, 100);

            document.getElementById('header-progress-bar').style.width = `${percentage}%`;
            document.getElementById('header-calories-text').innerHTML = `${eaten} <span class="text-white">KCAL VALID√âES</span>`;
            document.getElementById('goal-calories-eaten').innerText = eaten;
            
            const circle = document.getElementById('progress-circle');
            circle.style.strokeDashoffset = 263.89 - (263.89 * percentage) / 100;
            
            if (percentage >= 100) {
                document.getElementById('goal-message-container').innerHTML = `<div class="bg-neon/10 border border-neon/30 text-neon p-3 rounded-xl font-black uppercase tracking-widest shadow-[0_0_20px_rgba(0,255,136,0.2)]">Objectif Explos√© ! üöÄ</div>`;
            } else {
                document.getElementById('goal-calories-remaining').innerText = `${DAILY_GOAL - eaten} KCAL`;
            }
        }

        function initChallengeOfDay() {
            const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            const challenge = DAILY_CHALLENGES[dayOfYear % DAILY_CHALLENGES.length];
            document.getElementById('challenge-title').innerHTML = challenge.title;
            document.getElementById('challenge-desc').innerHTML = challenge.desc;
        }

        function renderHistory() {
            if (historyData.length === 0) {
                document.getElementById('history-empty').classList.remove('hidden');
                document.getElementById('history-list').classList.add('hidden');
                return;
            }
            document.getElementById('history-empty').classList.add('hidden');
            document.getElementById('history-list').classList.remove('hidden');

            document.getElementById('history-list').innerHTML = historyData.map(meal => {
                const p = meal.results.items.reduce((sum, i) => sum + i.protein, 0);
                const c = meal.results.items.reduce((sum, i) => sum + i.carbs, 0);
                return `
                    <div class="bg-darkcard border border-zinc-800 rounded-[2rem] p-3 flex gap-4 items-center">
                        <img src="${meal.image}" class="w-20 h-20 rounded-2xl object-cover border border-zinc-800" />
                        <div class="flex-1 pr-2">
                            <div class="flex justify-between items-start mb-1">
                                <h4 class="font-black text-white uppercase text-sm">Log <span class="text-neon">Valid√©</span></h4>
                                <span class="font-black text-neon">${Math.round(meal.results.totalCalories)}</span>
                            </div>
                            <p class="text-[10px] text-zinc-500 font-bold uppercase tracking-widest mb-3"><i class="fa-solid fa-bolt text-neon mr-1"></i> ${meal.date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'})}</p>
                            <div class="flex gap-2 text-[9px] font-black uppercase tracking-widest">
                                <span class="bg-black border border-zinc-800 text-white px-2 py-1 rounded-md shadow-inner">PRO: <span class="text-neon">${Math.round(p)}g</span></span>
                                <span class="bg-black border border-zinc-800 text-white px-2 py-1 rounded-md shadow-inner">GLU: <span class="text-neon">${Math.round(c)}g</span></span>
                            </div>
                        </div>
                    </div>`;
            }).join('');
        }
    </script>
</body>
</html>


