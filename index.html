<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulking Tracker - NutriScan</title>
    <!-- Utilisation de Tailwind CSS via CDN pour le style rapide -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome pour les ic√¥nes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- ========================================== -->
    <!-- DEBUT DU FICHIER CSS (A mettre dans style.css) -->
    <!-- ========================================== -->
    <style>
        /* Animations et styles personnalis√©s */
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8fafc; /* slate-50 */
            -webkit-tap-highlight-color: transparent;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        .slide-up {
            animation: slideUp 0.4s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cercle de progression SVG */
        .progress-ring__circle {
            transition: stroke-dashoffset 1s ease-out;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        /* Masquer la scrollbar pour un look plus propre */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Styles de la navigation active */
        .nav-btn.active { color: #059669; } /* emerald-600 */
        .nav-btn.active .nav-icon-bg { background-color: #d1fae5; } /* emerald-100 */
        
        .nav-btn-goal.active { color: #2563eb; } /* blue-600 */
        .nav-btn-goal.active .nav-icon-bg { background-color: #dbeafe; } /* blue-100 */
        
        .nav-btn-history.active { color: #9333ea; } /* purple-600 */
        .nav-btn-history.active .nav-icon-bg { background-color: #f3e8ff; } /* purple-100 */
    </style>
    <!-- ========================================== -->
    <!-- FIN DU FICHIER CSS -->
    <!-- ========================================== -->
</head>
<body class="text-slate-900 pb-20 sm:pb-0 sm:flex sm:justify-center sm:items-start sm:p-6 min-h-screen">

    <!-- ========================================== -->
    <!-- DEBUT DU FICHIER HTML (Structure)          -->
    <!-- ========================================== -->
    <div class="w-full sm:max-w-md bg-white sm:rounded-3xl sm:shadow-2xl overflow-hidden flex flex-col min-h-screen sm:min-h-[850px] relative">
        
        <!-- En-t√™te Global -->
        <header class="bg-emerald-600 px-6 pt-10 pb-6 text-white sm:rounded-t-3xl rounded-b-3xl shadow-md z-10 relative">
            <div class="flex items-center justify-between mb-2">
                <div>
                    <h1 class="text-2xl font-bold tracking-tight">Bulking Tracker</h1>
                    <p class="text-emerald-100 text-sm font-medium">Objectif : 65 kg (soit +10 kg)</p>
                </div>
                <div class="bg-white/20 p-2.5 rounded-2xl backdrop-blur-sm">
                    <i class="fa-solid fa-arrow-trend-up text-2xl"></i>
                </div>
            </div>
            
            <!-- Barre de progression globale -->
            <div class="mt-4 bg-emerald-700/50 rounded-full h-1.5 w-full overflow-hidden">
                <div id="header-progress-bar" class="bg-emerald-300 h-full rounded-full transition-all duration-1000" style="width: 0%"></div>
            </div>
            <div class="flex justify-between mt-1 text-xs text-emerald-100 font-medium">
                <span id="header-calories-text">0 kcal mang√©es</span>
                <span>Objectif: 2850</span>
            </div>
        </header>

        <!-- Contenu Principal -->
        <main class="flex-1 overflow-y-auto p-5 no-scrollbar relative">

            <!-- VUE 1 : SCANNER -->
            <section id="view-scan" class="fade-in block">
                <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-camera text-emerald-500"></i> Scanner un repas
                </h2>

                <!-- Zone d'upload -->
                <div id="upload-zone" onclick="document.getElementById('file-input').click()" class="border-2 border-dashed border-slate-300 rounded-3xl p-10 flex flex-col items-center justify-center text-center cursor-pointer hover:bg-slate-50 hover:border-emerald-400 transition-colors bg-white shadow-sm block">
                    <div class="bg-emerald-100 text-emerald-600 p-5 rounded-full mb-4 shadow-inner">
                        <i class="fa-solid fa-camera text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2 text-slate-700">Prendre une photo</h3>
                    <p class="text-slate-500 text-sm">Prenez votre assiette en photo pour estimer les calories</p>
                </div>

                <!-- Aper√ßu de l'image -->
                <div id="image-preview-container" class="relative rounded-3xl overflow-hidden shadow-lg mb-6 bg-black hidden">
                    <img id="image-preview" src="" alt="Repas" class="w-full h-72 object-cover opacity-90" />
                    <button id="btn-reset" onclick="resetScanner()" class="absolute top-4 right-4 bg-white/90 backdrop-blur-sm text-slate-800 w-10 h-10 rounded-full shadow-lg hover:scale-105 transition-transform flex items-center justify-center">
                        <i class="fa-solid fa-rotate-right"></i>
                    </button>
                </div>

                <input type="file" id="file-input" accept="image/*" class="hidden" onchange="handleImageUpload(event)" />

                <!-- Message d'erreur -->
                <div id="error-message" class="hidden mt-4 p-4 bg-red-50 text-red-700 rounded-2xl flex items-start gap-3 text-sm border border-red-100">
                    <i class="fa-solid fa-circle-exclamation mt-0.5"></i>
                    <p id="error-text"></p>
                </div>

                <!-- Bouton Analyser -->
                <button id="btn-analyze" onclick="analyzeImage()" class="hidden w-full mt-2 bg-slate-900 hover:bg-slate-800 text-white font-bold py-4 rounded-2xl flex items-center justify-center gap-2 shadow-xl shadow-slate-900/20 transition-all active:scale-95 text-lg">
                    <i class="fa-solid fa-bolt text-yellow-400"></i> Calculer les calories
                </button>

                <!-- Zone de chargement -->
                <div id="loading-zone" class="hidden mt-8 flex flex-col items-center justify-center text-center bg-white p-8 rounded-3xl shadow-sm border border-slate-100">
                    <i class="fa-solid fa-circle-notch fa-spin text-emerald-500 text-4xl mb-4"></i>
                    <h3 class="text-xl font-bold text-slate-800">Analyse de l'assiette...</h3>
                    <p class="text-slate-500 text-sm mt-2">Recherche des meilleurs nutriments pour ta prise de masse.</p>
                </div>

                <!-- R√©sultats -->
                <div id="results-zone" class="hidden mt-4 slide-up">
                    <div class="bg-gradient-to-br from-emerald-50 to-teal-50 rounded-3xl p-6 mb-6 border border-emerald-100 shadow-sm relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-10">
                            <i class="fa-solid fa-arrow-trend-up text-8xl"></i>
                        </div>
                        <p class="text-emerald-800 text-sm font-bold uppercase tracking-wider mb-2 flex items-center gap-2">
                            <i class="fa-solid fa-circle-check"></i> Apport estim√©
                        </p>
                        <div class="flex items-baseline gap-1 mb-4">
                            <span id="result-total-calories" class="text-6xl font-black text-emerald-600 tracking-tighter">0</span>
                            <span class="text-xl font-bold text-emerald-800/60">kcal</span>
                        </div>
                        
                        <div class="flex justify-between gap-3 text-center text-sm">
                            <div class="bg-white/60 backdrop-blur-sm rounded-2xl p-3 flex-1 shadow-sm border border-white">
                                <span id="result-protein" class="block font-black text-lg text-slate-800">0g</span>
                                <span class="text-xs font-semibold text-slate-500">Prot√©ines</span>
                            </div>
                            <div class="bg-white/60 backdrop-blur-sm rounded-2xl p-3 flex-1 shadow-sm border border-white">
                                <span id="result-carbs" class="block font-black text-lg text-slate-800">0g</span>
                                <span class="text-xs font-semibold text-slate-500">Glucides</span>
                            </div>
                            <div class="bg-white/60 backdrop-blur-sm rounded-2xl p-3 flex-1 shadow-sm border border-white">
                                <span id="result-fat" class="block font-black text-lg text-slate-800">0g</span>
                                <span class="text-xs font-semibold text-slate-500">Lipides</span>
                            </div>
                        </div>
                    </div>

                    <h3 class="font-bold text-slate-800 mb-3 ml-1">D√©tails de l'assiette</h3>
                    <div id="results-items" class="space-y-3 mb-6">
                        <!-- Les items seront inject√©s ici en JS -->
                    </div>

                    <button onclick="switchTab('goal'); resetScanner();" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-800 font-bold py-4 rounded-2xl transition-colors mb-4">
                        Voir ma progression
                    </button>
                </div>
            </section>

            <!-- VUE 2 : OBJECTIF -->
            <section id="view-goal" class="fade-in hidden">
                <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-bullseye text-blue-500"></i> Progression du jour
                </h2>

                <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-100 mb-6 text-center">
                    <div class="relative w-48 h-48 mx-auto mb-4">
                        <!-- Cercle SVG -->
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="40" stroke="#f1f5f9" stroke-width="12" fill="none" />
                            <circle id="progress-circle" class="progress-ring__circle" cx="50" cy="50" r="40" stroke="#3b82f6" stroke-width="12" fill="none" stroke-linecap="round" stroke-dasharray="251.2" stroke-dashoffset="251.2" />
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <span id="goal-calories-eaten" class="text-3xl font-black text-slate-800">0</span>
                            <span class="text-sm font-semibold text-slate-400">/ 2850 kcal</span>
                        </div>
                    </div>

                    <div id="goal-message-container">
                        <p class="text-slate-600 font-medium">
                            Encore <span id="goal-calories-remaining" class="text-blue-600 font-bold">2850 kcal</span> pour atteindre ton but aujourd'hui. Ne l√¢che rien !
                        </p>
                    </div>
                </div>

                <!-- D√©fi du jour -->
                <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-bolt text-yellow-500"></i> D√©fi du jour
                </h2>
                
                <div class="bg-gradient-to-r from-amber-500 to-orange-500 rounded-3xl p-6 text-white shadow-lg shadow-orange-500/20">
                    <div class="bg-white/20 w-max px-3 py-1 rounded-full text-xs font-bold tracking-wider mb-3 uppercase backdrop-blur-sm">
                        Astuce Prise de Masse
                    </div>
                    <h3 id="challenge-title" class="text-xl font-bold mb-2">Chargement...</h3>
                    <p id="challenge-desc" class="text-orange-50 font-medium leading-relaxed text-sm"></p>
                </div>
            </section>

            <!-- VUE 3 : HISTORIQUE -->
            <section id="view-history" class="fade-in hidden">
                <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-clock-rotate-left text-purple-500"></i> Historique des repas
                </h2>

                <div id="history-empty" class="text-center py-16 px-4">
                    <div class="bg-slate-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fa-solid fa-utensils text-3xl text-slate-400"></i>
                    </div>
                    <h3 class="text-lg font-bold text-slate-700">Aucun repas scann√©</h3>
                    <p class="text-slate-500 text-sm mt-2">Commence par scanner ton premier repas pour alimenter l'historique.</p>
                    <button onclick="switchTab('scan')" class="mt-6 bg-slate-900 text-white font-bold py-3 px-6 rounded-xl">
                        Scanner un repas
                    </button>
                </div>

                <div id="history-list" class="space-y-4 hidden">
                    <!-- Les √©l√©ments de l'historique seront inject√©s ici -->
                </div>
            </section>

        </main>

        <!-- Navigation du bas -->
        <nav class="fixed sm:absolute bottom-0 left-0 right-0 bg-white border-t border-slate-100 px-6 py-3 flex justify-between items-center z-50 rounded-b-3xl">
            <button onclick="switchTab('scan')" id="nav-scan" class="nav-btn active flex flex-col items-center p-2 transition-colors text-slate-400 hover:text-slate-600">
                <div class="nav-icon-bg p-1.5 rounded-xl transition-colors">
                    <i class="fa-solid fa-house text-xl"></i>
                </div>
                <span class="text-[10px] font-bold mt-1">Scanner</span>
            </button>
            
            <button onclick="switchTab('goal')" id="nav-goal" class="nav-btn-goal flex flex-col items-center p-2 transition-colors text-slate-400 hover:text-slate-600">
                <div class="nav-icon-bg p-1.5 rounded-xl transition-colors">
                    <i class="fa-solid fa-bullseye text-xl"></i>
                </div>
                <span class="text-[10px] font-bold mt-1">Objectif</span>
            </button>

            <button onclick="switchTab('history')" id="nav-history" class="nav-btn-history flex flex-col items-center p-2 transition-colors text-slate-400 hover:text-slate-600">
                <div class="nav-icon-bg p-1.5 rounded-xl transition-colors">
                    <i class="fa-solid fa-clock-rotate-left text-xl"></i>
                </div>
                <span class="text-[10px] font-bold mt-1">Historique</span>
            </button>
        </nav>
    </div>
    <!-- ========================================== -->
    <!-- FIN DU FICHIER HTML                        -->
    <!-- ========================================== -->

    <!-- ========================================== -->
    <!-- DEBUT DU FICHIER JAVASCRIPT (script.js)    -->
    <!-- ========================================== -->
    <script>
        // --- CONSTANTES ET ETAT GLOBAL ---
        const DAILY_GOAL = 2850;
        let currentImageBase64 = null;
        let currentMimeType = null;
        let historyData = [];

        // D√©fis quotidiens
        const DAILY_CHALLENGES = [
            { title: "Le pouvoir des ol√©agineux", desc: "Mange une grosse poign√©e d'amandes, noix ou noix de cajou aujourd'hui en collation (+250 kcal facilement)." },
            { title: "L'or liquide", desc: "Ajoute une cuill√®re √† soupe d'huile d'olive suppl√©mentaire sur ton plat principal √† midi ou ce soir (+120 kcal)." },
            { title: "Smoothie de champion", desc: "Pr√©pare un smoothie avec 1 banane, du lait entier et 2 grosses cuill√®res de beurre de cacahu√®te." },
            { title: "Z√©ro repas saut√©", desc: "Ton d√©fi aujourd'hui : faire 3 vrais repas complets et au moins 1 collation l'apr√®s-midi." },
            { title: "Dessert gourmand", desc: "Ce soir, autorise-toi un dessert riche (fromage blanc entier au miel, chocolat, ou g√¢teau)." },
            { title: "Hydratation calorique", desc: "Remplace un verre d'eau par un grand verre de jus de fruit pur jus ou de lait entier aujourd'hui." },
            { title: "Double dose de f√©culents", desc: "Augmente ta portion de riz, p√¢tes ou pommes de terre de 30% lors de ton repas de midi." }
        ];

        // --- INITIALISATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initChallengeOfDay();
            updateProgressUI();
        });

        // --- GESTION DES ONGLETS (NAVIGATION) ---
        function switchTab(tabId) {
            // Cacher toutes les vues
            document.getElementById('view-scan').classList.add('hidden');
            document.getElementById('view-goal').classList.add('hidden');
            document.getElementById('view-history').classList.add('hidden');
            
            // Retirer les classes actives de la nav
            document.getElementById('nav-scan').classList.remove('active');
            document.getElementById('nav-goal').classList.remove('active');
            document.getElementById('nav-history').classList.remove('active');

            // Afficher la vue demand√©e
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            document.getElementById(`nav-${tabId}`).classList.add('active');

            if (tabId === 'history') renderHistory();
        }

        // --- LOGIQUE METIER & UPLOAD ---
        function handleImageUpload(event) {
            const file = event.target.files[0];
            const errorZone = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');

            if (file) {
                if (!file.type.startsWith('image/')) {
                    errorText.innerText = "Veuillez s√©lectionner une image valide.";
                    errorZone.classList.remove('hidden');
                    return;
                }
                
                const reader = new FileReader();
                reader.onloadend = () => {
                    const result = reader.result;
                    currentImageBase64 = result.split(',')[1];
                    currentMimeType = result.split(';')[0].split(':')[1];
                    
                    // Mise √† jour de l'UI
                    document.getElementById('image-preview').src = result;
                    document.getElementById('upload-zone').classList.add('hidden');
                    document.getElementById('image-preview-container').classList.remove('hidden');
                    document.getElementById('btn-analyze').classList.remove('hidden');
                    document.getElementById('results-zone').classList.add('hidden');
                    errorZone.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function resetScanner() {
            document.getElementById('file-input').value = '';
            currentImageBase64 = null;
            currentMimeType = null;
            
            document.getElementById('upload-zone').classList.remove('hidden');
            document.getElementById('image-preview-container').classList.add('hidden');
            document.getElementById('btn-analyze').classList.add('hidden');
            document.getElementById('results-zone').classList.add('hidden');
            document.getElementById('error-message').classList.add('hidden');
            document.getElementById('btn-reset').classList.remove('hidden');
        }

        // --- APPEL API GEMINI ---
        async function analyzeImage() {
            if (!currentImageBase64) return;
            
            // UI : Afficher chargement
            document.getElementById('btn-analyze').classList.add('hidden');
            document.getElementById('btn-reset').classList.add('hidden');
            document.getElementById('loading-zone').classList.remove('hidden');
            document.getElementById('error-message').classList.add('hidden');

            const apiKey = ""; // La cl√© est fournie par l'environnement
            
            const prompt = `Analyse cette image de nourriture. 
            1. Identifie tous les aliments pr√©sents.
            2. Estime les calories pour chaque aliment.
            3. Estime les macronutriments (prot√©ines, glucides, lipides) en grammes.
            4. Calcule le total des calories.
            Sois g√©n√©reux sur les estimations, l'utilisateur cherche √† prendre du poids.`;

            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: prompt },
                        { inlineData: { mimeType: currentMimeType, data: currentImageBase64 } }
                    ]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            items: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        name: { type: "STRING" },
                                        calories: { type: "NUMBER" },
                                        protein: { type: "NUMBER" },
                                        carbs: { type: "NUMBER" },
                                        fat: { type: "NUMBER" },
                                        portion: { type: "STRING" }
                                    },
                                    required: ["name", "calories", "protein", "carbs", "fat", "portion"]
                                }
                            },
                            totalCalories: { type: "NUMBER" }
                        },
                        required: ["items", "totalCalories"]
                    }
                }
            };

            let attempt = 0;
            let success = false;

            while (attempt < 3 && !success) {
                try {
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        }
                    );

                    if (!response.ok) throw new Error("Erreur r√©seau");

                    const data = await response.json();
                    const jsonText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    const parsedResult = JSON.parse(jsonText);

                    // Sauvegarde dans l'historique
                    saveToHistory(parsedResult);
                    // Affichage des r√©sultats
                    displayResults(parsedResult);
                    success = true;

                } catch (err) {
                    attempt++;
                    if (attempt >= 3) {
                        document.getElementById('error-text').innerText = "Impossible d'analyser l'image apr√®s plusieurs tentatives.";
                        document.getElementById('error-message').classList.remove('hidden');
                        document.getElementById('btn-analyze').classList.remove('hidden');
                        document.getElementById('btn-reset').classList.remove('hidden');
                    } else {
                        await new Promise(r => setTimeout(r, 1000 * attempt));
                    }
                }
            }

            document.getElementById('loading-zone').classList.add('hidden');
        }

        // --- AFFICHAGE DES RESULTATS ---
        function displayResults(results) {
            document.getElementById('results-zone').classList.remove('hidden');
            
            // Totaux
            document.getElementById('result-total-calories').innerText = Math.round(results.totalCalories);
            
            let totalP = 0, totalC = 0, totalF = 0;
            let itemsHtml = '';

            results.items.forEach(item => {
                totalP += item.protein;
                totalC += item.carbs;
                totalF += item.fat;

                itemsHtml += `
                    <div class="bg-white border border-slate-100 rounded-2xl p-4 shadow-sm flex flex-col">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-slate-800 capitalize">${item.name}</h4>
                                <p class="text-xs font-medium text-slate-500">${item.portion}</p>
                            </div>
                            <span class="font-bold text-slate-700 bg-slate-100 px-3 py-1.5 rounded-xl text-sm">
                                ${Math.round(item.calories)} kcal
                            </span>
                        </div>
                    </div>
                `;
            });

            document.getElementById('result-protein').innerText = `${Math.round(totalP)}g`;
            document.getElementById('result-carbs').innerText = `${Math.round(totalC)}g`;
            document.getElementById('result-fat').innerText = `${Math.round(totalF)}g`;
            
            document.getElementById('results-items').innerHTML = itemsHtml;
            updateProgressUI();
        }

        // --- GESTION DES DONNEES ET DE L'OBJECTIF ---
        function saveToHistory(results) {
            const newItem = {
                id: Date.now(),
                date: new Date(),
                image: document.getElementById('image-preview').src,
                results: results
            };
            historyData.unshift(newItem); // Ajoute au d√©but
        }

        function getTodaysCalories() {
            const today = new Date().toDateString();
            return historyData
                .filter(meal => meal.date.toDateString() === today)
                .reduce((sum, meal) => sum + meal.results.totalCalories, 0);
        }

        function updateProgressUI() {
            const eaten = Math.round(getTodaysCalories());
            const percentage = Math.min((eaten / DAILY_GOAL) * 100, 100);

            // Mise √† jour du Header
            document.getElementById('header-progress-bar').style.width = `${percentage}%`;
            document.getElementById('header-calories-text').innerText = `${eaten} kcal mang√©es`;

            // Mise √† jour de la vue Objectif
            document.getElementById('goal-calories-eaten').innerText = eaten;
            
            // Animation du cercle SVG (circonf√©rence = 251.2)
            const circle = document.getElementById('progress-circle');
            const offset = 251.2 - (251.2 * percentage) / 100;
            circle.style.strokeDashoffset = offset;
            
            // Changement de couleur si objectif atteint
            if (percentage >= 100) {
                circle.setAttribute('stroke', '#10b981'); // Vert
                document.getElementById('goal-message-container').innerHTML = `
                    <div class="bg-emerald-50 text-emerald-700 p-3 rounded-xl font-bold animate-pulse">
                        üéâ Objectif atteint ! Bien jou√© !
                    </div>`;
            } else {
                circle.setAttribute('stroke', '#3b82f6'); // Bleu
                const remaining = Math.max(0, DAILY_GOAL - eaten);
                document.getElementById('goal-calories-remaining').innerText = `${remaining} kcal`;
            }
        }

        function initChallengeOfDay() {
            // Calcule le jour de l'ann√©e pour avoir un d√©fi diff√©rent chaque jour
            const now = new Date();
            const start = new Date(now.getFullYear(), 0, 0);
            const diff = now - start;
            const oneDay = 1000 * 60 * 60 * 24;
            const dayOfYear = Math.floor(diff / oneDay);
            
            const challenge = DAILY_CHALLENGES[dayOfYear % DAILY_CHALLENGES.length];
            document.getElementById('challenge-title').innerText = challenge.title;
            document.getElementById('challenge-desc').innerText = challenge.desc;
        }

        // --- GESTION DE L'HISTORIQUE ---
        function renderHistory() {
            const emptyState = document.getElementById('history-empty');
            const listState = document.getElementById('history-list');

            if (historyData.length === 0) {
                emptyState.classList.remove('hidden');
                listState.classList.add('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            listState.classList.remove('hidden');

            let html = '';
            historyData.forEach(meal => {
                const totalCal = Math.round(meal.results.totalCalories);
                let p = 0, c = 0;
                meal.results.items.forEach(i => { p += i.protein; c += i.carbs; });
                
                const timeString = meal.date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});

                html += `
                    <div class="bg-white border border-slate-100 rounded-3xl p-3 shadow-sm flex gap-4 items-center">
                        <img src="${meal.image}" alt="Repas" class="w-20 h-20 rounded-2xl object-cover" />
                        <div class="flex-1">
                            <div class="flex justify-between items-start mb-1">
                                <h4 class="font-bold text-slate-800">Repas scann√©</h4>
                                <span class="font-black text-emerald-600">${totalCal} <span class="text-xs font-normal">kcal</span></span>
                            </div>
                            <p class="text-xs text-slate-400 mb-2"><i class="fa-regular fa-clock"></i> Aujourd'hui √† ${timeString}</p>
                            <div class="flex gap-2 text-[10px] font-bold">
                                <span class="bg-slate-100 text-slate-600 px-2 py-1 rounded-lg">P: ${Math.round(p)}g</span>
                                <span class="bg-slate-100 text-slate-600 px-2 py-1 rounded-lg">G: ${Math.round(c)}g</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            listState.innerHTML = html;
        }
    </script>
    <!-- ========================================== -->
    <!-- FIN DU FICHIER JAVASCRIPT                  -->
    <!-- ========================================== -->

</body>
</html>

